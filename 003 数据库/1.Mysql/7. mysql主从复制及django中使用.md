[TOC]

#### MySQL主从复制

下面是基于于Docker配置MySQL主从复制。我们事先准备好MySQL的配置文件以及保存MySQL数据和运行日志的目录，然后通过Docker的数据目录挂载来指定容器的配置、数据和日志文件的位置。

```Shell
root
└── mysql
    ├── master
    │   ├── conf
    |	└── data
    └── slave-1
    |	├── conf
    |	└── data
    └── slave-2
    |	├── conf
    |	└── data
    └── slave-3
    	├── conf
    	└── data
```

1. ##### MySQL的配置文件（master和slave的配置文件需要不同的server-id）

   ```
   [mysqld]
   pid-file=/var/run/mysqld/mysqld.pid    #进程号保存文件
   socket=/var/run/mysqld/mysqld.sock		
   datadir=/var/lib/mysql			 	   #数据文件	
   log-error=/var/log/mysql/error.log	   #错误日志文件
   server-id=1							   #主机从机server-id不能一样
   log-bin=/var/log/mysql/mysql-bin.log   #二进制日志文件，记录了数据改变的操作
   
   expire_logs_days=30					   #日志过期时间	
   max_binlog_size=256M				   #二进制日志文件最大大小
   symbolic-links=0
   # slow_query_log=ON					   #开启慢查询
   # slow_query_log_file=/var/log/mysql/slow.log  #慢查询日志
   # long_query_time=1					   #超过 1秒为慢查询
   # binlog_do_db  = xxx # 主从复制的库
   binlog_ignore_db = mysql # 不参与主从复制的库
   ```

2. ##### 创建和配置master

   ```Shell
   docker run -d -p 3306:3306 --name mysql-master \
   -v /data/docker/mysql/master/conf:/etc/mysql/mysql.conf.d \
   -v /data/docker/mysql/master/data:/var/lib/mysql \
   -e MYSQL_ROOT_PASSWORD=y123456! mysql:5.7
   
   docker exec -it mysql-master /bin/bash
   ```

   ```Shell
   mysql -u root -p
   Enter password:
   Welcome to the MySQL monitor.  Commands end with ; or \g.
   Your MySQL connection id is 1
   Server version: 5.7.23-log MySQL Community Server (GPL)
   Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.
   Oracle is a registered trademark of Oracle Corporation and/or its
   affiliates. Other names may be trademarks of their respective
   owners.
   Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
   
   mysql> grant replication slave on *.* to 'slave'@'%' identified by 'iamslave';
   Query OK, 0 rows affected, 1 warning (0.00 sec)
   
   mysql> flush privileges;
   Query OK, 0 rows affected (0.00 sec)
   
   mysql> show master status;
   +------------------+----------+--------------+------------------+-------------------+
   | File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
   +------------------+----------+--------------+------------------+-------------------+
   | mysql-bin.000003 |      590 |              |                  |                   |
   +------------------+----------+--------------+------------------+-------------------+
   1 row in set (0.00 sec)
   
   mysql> quit
   Bye
   exit
   ```

   上面创建Docker容器时使用的`-v`参数（`--volume`）表示数据目录挂载，冒号前是宿主机的目录，冒号后是容器中的目录，这样相当于将宿主机中的目录挂载到了容器中。 要记录主机的日志文件，和日志位置position

3. ##### 备份主表中的数据（如果需要的话）

   ```SQL
   mysql> flush table with read lock;
   ```

   ```Bash
   mysqldump -u root -p 123456 -A -B > /root/backup/mysql/mybak$(date +"%Y%m%d%H%M%S").sql
   ```

   ```SQL
   mysql> unlock table;
   ```

4. ##### 创建和配置slave

   ```Shell
   docker run -d -p 3308:3306 --name mysql-slave-1 \
   -v /data/docker/mysql/slave-1/conf:/etc/mysql/mysql.conf.d \
   -v /data/docker/mysql/slave-1/data:/var/lib/mysql \
   -e MYSQL_ROOT_PASSWORD=y123456! \
   --link mysql-master:mysql-master mysql:5.7
   
   docker run -d -p 3309:3306 --name mysql-slave-1 \
   -v /data/docker/mysql/slave-2/conf:/etc/mysql/mysql.conf.d \
   -v /data/docker/mysql/slave-2/data:/var/lib/mysql \
   -e MYSQL_ROOT_PASSWORD=y123456! \
   --link mysql-master:mysql-master mysql:5.7
   
   docker run -d -p 3310:3306 --name mysql-slave-1 \
   -v /data/docker/mysql/slave-3/conf:/etc/mysql/mysql.conf.d \
   -v /data/docker/mysql/slave-3/data:/var/lib/mysql \
   -e MYSQL_ROOT_PASSWORD=y123456! \
   --link mysql-master:mysql-master mysql:5.7
   
   docker exec -it mysql-slave-1 /bin/bash
   ```

   ```Shell
   mysql -u root -p
   Enter password:
   Welcome to the MySQL monitor.  Commands end with ; or \g.
   Your MySQL connection id is 2
   Server version: 5.7.23-log MySQL Community Server (GPL)
   Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.
   Oracle is a registered trademark of Oracle Corporation and/or its
   affiliates. Other names may be trademarks of their respective
   owners.
   Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
   
   mysql> reset slave;
   Query OK, 0 rows affected (0.02 sec)
   
   mysql> change master to master_host='mysql-master', master_user='slave', master_password='iamslave',master_log_file='mysql-bin.000003', master_log_pos=590;
   Query OK, 0 rows affected, 2 warnings (0.03 sec)
   
   mysql> start slave;
   Query OK, 0 rows affected (0.01 sec)
   
   mysql> show slave status\G
   *************************** 1. row ***************************
                  Slave_IO_State: Waiting for master to send event
                     Master_Host: mysql57
                     Master_User: slave
                     Master_Port: 3306
                   Connect_Retry: 60
                 Master_Log_File: mysql-bin.000001
             Read_Master_Log_Pos: 590
                  Relay_Log_File: f352f05eb9d0-relay-bin.000002
                   Relay_Log_Pos: 320
           Relay_Master_Log_File: mysql-bin.000001
                Slave_IO_Running: Yes
               Slave_SQL_Running: Yes
                Replicate_Do_DB:
             Replicate_Ignore_DB:
              Replicate_Do_Table:
          Replicate_Ignore_Table:
         Replicate_Wild_Do_Table:
     Replicate_Wild_Ignore_Table:
                      Last_Errno: 0
                      Last_Error:
                    Skip_Counter: 0
             Exec_Master_Log_Pos: 590
                 Relay_Log_Space: 534
                 Until_Condition: None
                  Until_Log_File:
                   Until_Log_Pos: 0
              Master_SSL_Allowed: No
              Master_SSL_CA_File:
              Master_SSL_CA_Path:
                 Master_SSL_Cert:
               Master_SSL_Cipher:
                  Master_SSL_Key:
           Seconds_Behind_Master: 0
   Master_SSL_Verify_Server_Cert: No
                   Last_IO_Errno: 0
                   Last_IO_Error:
                  Last_SQL_Errno: 0
                  Last_SQL_Error:
     Replicate_Ignore_Server_Ids:
                Master_Server_Id: 1
                     Master_UUID: 30c38043-ada1-11e8-8fa1-0242ac110002
                Master_Info_File: /var/lib/mysql/master.info
                       SQL_Delay: 0
             SQL_Remaining_Delay: NULL
         Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
              Master_Retry_Count: 86400
                     Master_Bind:
         Last_IO_Error_Timestamp:
        Last_SQL_Error_Timestamp:
                  Master_SSL_Crl:
              Master_SSL_Crlpath:
              Retrieved_Gtid_Set:
               Executed_Gtid_Set:
                   Auto_Position: 0
            Replicate_Rewrite_DB:
                    Channel_Name:
              Master_TLS_Version:
   1 row in set (0.00 sec)
   
   mysql> quit
   Bye
   exit
   ```

   接下来可以如法炮制配置出slave2和slave3，这样就可以搭建起一个“一主带三从”的主从复制环境。上面创建创建容器时使用的`--link`参数用来配置容器在网络上的主机名（网络地址别名)
   
   ```
   参数解释：
   master_host     要连接的主服务器的IP地址
   master_port     要连接的主机的端口号
   master_user     要连接的主服务器用户名
   master_user     要连接的主服务器密码
   master_log_file 主服务器的bin日志的日志名称
   master_log_pos  服务器的bin日志的记录位置,后一项不需要加引号。否则配置失败
   此外 ip也可以使用master容器内部的虚拟IP地址172.17.0.3。
   在master容器中,执行  cat /etc/hosts
   返回：
   127.0.0.1	localhost
   ::1	localhost ip6-localhost ip6-loopback
   fe00::0	ip6-localnet
   ff00::0	ip6-mcastprefix
   ff02::1	ip6-allnodes
   ff02::2	ip6-allrouters
   172.17.0.3	0c93e02a453d
   ```
   
   

#### django中使用

- 配置好主从复制后，写数据的操作应该master上执行，而读数据的操作应该在slave上完成。为此，在Django项目中需要配置DATABASE_ROUTERS并通过自定义的主从复制路由类来实现读写分离操作.

```Python
#setting中配置
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'zufang',
        'HOST': '39.100.114.253',
        'PORT': 3306,
        'USER': 'yuxm',
        'PASSWORD': 'y123456!',
        'CHARSET': 'utf8',
        'TIME_ZONE': 'Asia/Shanghai',
    },
    # 'slave1': {
    #     'ENGINE': 'django.db.backends.mysql',
    #     'NAME': 'zufang',
    #     'HOST': '120.77.222.217',
    #     'PORT': 3308,
    #     'USER': 'luohao1',
    #     'PASSWORD': 'Luohao.618',
    #     'CHARSET': 'utf8',
    #     'TIME_ZONE': 'Asia/Shanghai',
    # },
    # 'slave2': {
    #     'ENGINE': 'django.db.backends.mysql',
    #     'NAME': 'zufang',
    #     'HOST': '120.77.222.217',
    #     'PORT': 3309,
    #     'USER': 'luohao2',
    #     'PASSWORD': 'Luohao.618',
    #     'CHARSET': 'utf8',
    #     'TIME_ZONE': 'Asia/Shanghai',
    # },
    # 'slave3': {
    #     'ENGINE': 'django.db.backends.mysql',
    #     'NAME': 'zufang',
    #     'HOST': '120.77.222.217',
    #     'PORT': 3310,
    #     'USER': 'luohao3',
    #     'PASSWORD': 'Luohao.618',
    #     'CHARSET': 'utf8',
    #     'TIME_ZONE': 'Asia/Shanghai',
    # },
    'backend': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'zufang',
        'HOST': '39.100.114.253',
        'PORT': 3306,
        'USER': 'yuxm',
        'PASSWORD': 'y123456!',
        'CHARSET': 'utf8',
        'TIME_ZONE': 'Asia/Shanghai',
    },
}
#一主三从 再加另外一个单独的
DATABASE_ROUTERS DATABASE_ROUTERS = [
    'common.routers.MasterSlaveRouter',  #下面类的位置
]

```

```Python
class MasterSlaveRouter(object):
    """主从复制路由"""

    @staticmethod
    def db_for_read(model, **hints):
        """
        Attempts to read auth models go to auth_db.
        """
        #‘backend'数据库对应的模型手动在元类中设置一个字段区分 app_label = 'hrs'
		if model._meta.app_label == 'hrs':
            return 'backend'
        return random.choice(('slave1', 'slave2', 'slave3'))

    @staticmethod
    def db_for_write(model, **hints):
        """
        Attempts to write auth models go to auth_db.
        """
        #‘backend'数据库对应的模型手动在元类中设置一个字段区分 app_label = 'hrs'
		if model._meta.app_label == 'hrs':    
            return 'backend'
        return 'default'

    @staticmethod
    def allow_relation(obj1, obj2, **hints):
        """
        Allow relations if a model in the auth app is involved.
        """
        return None

    @staticmethod
    def allow_migrate(db, app_label, model_name=None, **hints):
        """
        Make sure the auth app only appears in the 'auth_db'
        database.
        """
        return True
```

Django官方文档的[DATABASE_ROUTERS配置](https://docs.djangoproject.com/en/2.1/topics/db/multi-db/#topics-db-multi-db-routing)，

- mysql的默认配置在  vim  /etc/my.cnf

- cat /etc/my.cnf | grep -Ev "(^$)|(#.*)"  不查看空行和注释

- mysqldump  -h 39.100.114.253 -p 3307 -u root -p y123456!  > bak.sql

  

