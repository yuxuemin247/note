[TOC]

# MongoDB

## MongoDB简介

```python
'''
MongoDB是一个面向文档（document-oriented）的数据库，而不是关系型数据库。
爬虫的数据存储
可以放到mysql ,mysql 是关系型数据库 ,是基于硬盘存储的
当并发量太大时,mysql 可能无法支撑, 需要将数据库设计为分布式
mysql当然也支持分布式,但是分布式不是mysql的强项

反观MongoDB  ,它从一开始设计时就是奔着分布式去的,只需要简单的配置就能实现高效的分布式存储
被大量应用于大数据领域


mongoDB是一款基于C++ 编写分布式非关系型数据库
noSQL  Not only SQL


mongoDB 与 redis

mongoDB是最像关系型的非关系型数据,更加适用于大数据,redis则更倾向于,并发较小,数据较小,性能更高

为什么爬虫中需要使用mongoDB,就是因为一些爬虫程序要爬的数据非常多,简单的存储系统无法满足需求
'''

'''
  mongodb 与 mysql 对应名称
    mongoDB        mysql
    数据库         数据库
    集合             表
    文档(类似字典)   记录
    键值对          字段

注意:    MongoDB中区分大小写
'''
```

## MongoDB安装

### 下载与安装

下载地址：https://fastdl.mongodb.org/win32/mongodb-win32-x86_64-2008plus-ssl-4.0.8-signed.msi

取消勾选：Install MongoDB Compass

### 创建管理员

```python
cmd: mongo
use admin
db.createUser(
  {
    user: "root",
    pwd: "123",
    roles: [ { role: "root", db: "admin" } ]
  }
)
'''
更多角色请见:https://www.cnblogs.com/SamOk/p/5162767.html
'''
```

### 修改配置

```python
'''
bin：mongod.cfg
'''
  bind_ip:0.0.0.0	 #可用于远程连接，127.0.0.1就只能本地访问
security：
    authorization: enabled
# 注意缩进
```

重启MongoDB Server服务，启用认证！

## 登录

```python
'''
方式1  mongo -u "用户名" -p "密码"
方式2
	mongo 直接进入游客模式
    use 切换到与用户所在的数据库
    db.auth("用户名","密码") 返回1为成功 0为失败
'''
```

创建用户

```python
use test
db.createUser(
  {
    user: "jack",
    pwd: "123",
    roles: [ { role: "readWrite", db: "test" },
             { role: "read", db: "mydb" } ]
  }
)

在mongodb中用不同的数据库来区分权限,要管理哪个数据库就在哪个数据库下创建用户即可,创建管理员账户则在admin下创建!
db 是一个全局变量 表示当前数据库
db.createUser()是调用一个内部函数用于创建用户
每个账号可以具备多个角色
```

## 库的操作

```python
'''
use 数据库名称    -----> 创建数据库
db.dropDatabase()       删除数据库
show dbs			   查看所有数据库
use 切换数据库	------> 如果不存在会自动创建， 新建的数据库是查看不到的，因为里面没有数据
'''
'''
db.help : 查看mongo的方法
'''
```

## 集合的操作

```python
#创建集合
db.集合名称

#查看集合	没有数据不会显示
show collections
show tables
db.user.info.address      最多不超过128字节

#删除集合
db.集合名称.drop()
```

### 注意事项:

```python
需要注意的是：
#1、文档中的键/值对是有序的。
#2、文档中的值不仅可以是在双引号里面的字符串，还可以是其他几种数据类型（甚至可以是整个嵌入的文档)。
#3、MongoDB区分类型和大小写。
#4、MongoDB的文档不能有重复的键。
#5、文档中的值可以是多种不同的数据类型，也可以是一个完整的内嵌文档。文档的键是字符串。除了少数例外情况，键可以使用任意UTF-8字符。

文档键命名规范：
#1、键不能含有\0 (空字符)。这个字符用来表示键的结尾。
#2、.和$有特别的意义，只有在特定环境下才能使用。
#3、以下划线"_"开头的键是保留的(不是严格要求的)。
```

## 文档操作

### 插入数据

```python
#插入一条
db.user.insert({"_id":1})

#插入多条
db.user.insertMany([{"_id":3,"name":"张三丰"},{"_id":4,"name":"二狗子"}])

#插入变量
var user1 = {"_id":10,"name":"王五"}	#定义变量 var可以省略
db.user.insert(user1) 	#直接插入变量

# id 存在则覆盖，没有添加
db.user.save({"_id":10,"name":"狗子"})
```

```python
'''
mongodb的语法就是js的语法，所以json支持的数据类型，mongo都支持

支持的数据类型：
db.user.save({"_id":12,"a":"asdsafas","b":100,"c":1.1,"d":[1,2],
			"e":{"k1":"v1"},"f":true,"g":new Date(),"h":/^a.*c$/m})
'''
```

### 查询语句

```python
#查询所有
db.user.find(条件)	#db.user.find().pretty()  格式化查询结果

#查询第一个匹配的
db.user.findOne(条件)
```

#### 比较运算符

```python
'''
>   <   !=  >=   <=
gt  lt  ne  gte  lte
'''
db.user.find({"name":{"$ne":"张三丰"}})
db.user.find({"_id":{"$gt":3}})
#注意:字段名在外层 条件在里层
```

#### 逻辑运算符

```python
'''
and  or  not
'''
db.user.find({"$or":[{"name":"张三丰"},{"name":"狗子"}]})
#取余
db.user.find({"_id":{"$mod":[2,1]}})	# 对2 取余为 1 --> 奇数
#取反
db.user.find({"_id":{"$not":{"$mod":[2,1]}}})
```

#### 成员运算符

```python
'''
in   not in 
$in   $nin
'''
db.user.find({"_id":{"$in":[1,2]}})		# 不在 [1,2] 内的 ，结果为 id 为 1, 2 的结果

db.user.find({"_id":{"$nin":[1,2]}})
```

#### 正则匹配

```python
'''
 /正则表达式/i
'''
db.user.find({"name":/^j.*?(g|n)$/i})
```

#### 查询指定字段

```python
db.user.find({"_id":3},{"_id":0,"name":1,"age":1})		#查询id为3的结果 
					        0表示不显示		 1为显示		# 默认为0
```

#### 查询数组

```python
db.student.find({"hobbies":{"$all":["movie","muisc"]}})		# $all 可以加多个条件
db.student.find({"hobbies.1":"girl"})					   # hobbies.1  第一个hobbies 

# 查看所有人的 第一个和第二个爱好
db.student.find({},{"hobbies":{"$slice":[0,1]}})

#   $slice [1,1]  表示的是从第1个开始取1个
db.student.find({},{"hobbies":{"$slice":[1,1]}})

==========================================================================

# 排序		1为升序  -1为降序
db.user.find().sort({"_id":1})
db.user.find().sort({"_id":-1})

# 分页	limit：取多少条数据	skip：跳过前几条数据
db.user.find().sort({"age":1}).limit(10).skip(2)

# 获取数量
db.user.count({"price":{"$gt":30}})
db.user.find({'price':{"$gt":30}}).count()

# 匹配key值为null或key不存在的数据
db.user.find({"b":null})
```

## 修改数据

```python
db.collection.update(
   <query>,
   <update>,
   {
     upsert: <boolean>,
     multi: <boolean>,
     writeConcern: <document>
   }
)
query : 相当于where条件。
update : update的对象和一些更新的操作符（如$,$inc...等，相当于set后面的
upsert : 可选，默认为false，代表如果不存在update的记录不更新也不插入，设置为true代表插入。
multi : 可选，默认为false，代表只更新找到的第一条记录，设为true,代表更新找到的全部记录。
writeConcern :可选，抛出异常的级别。

更新操作是不可分割的：若两个更新同时发送，先到达服务器的先执行，然后执行另外一个，不会破坏文档。
```

### 覆盖式

不常用

```python
#注意：除非是删除，否则_id是始终不会变的
#1、覆盖式:
db.user.update({'age':20},{"name":"Wxx","hobbies_count":3})
是用{"_id":2,"name":"Wxx","hobbies_count":3}覆盖原来的记录

#2、一种最简单的更新就是用一个新的文档完全替换匹配的文档。这适用于大规模式迁移的情况。例如
var obj=db.user.findOne({"_id":2})

obj.username=obj.name+'SB'
obj.hobbies_count++
delete obj.age

db.user.update({"_id":2},obj)
```

### update的使用

```python
=========================================设置:$set=========================================


通常文档只会有一部分需要更新。可以使用原子性的更新修改器，指定对文档中的某些字段进行更新。
更新修改器是种特殊的键，用来指定复杂的更新操作，比如修改、增加后者删除

#1、update db1.user set  name="WXX" where id = 2
db.user.update({'_id':2},{"$set":{"name":"WXX",}})

#2、没有匹配成功则新增一条{"upsert":true}
db.user.update({'_id':6},{"$set":{"name":"egon","age":18}},{"upsert":true})

#3、默认只改匹配成功的第一条,{"multi":改多条}
db.user.update({'_id':{"$gt":4}},{"$set":{"age":28}})
db.user.update({'_id':{"$gt":4}},{"$set":{"age":38}},{"multi":true})

#4、修改内嵌文档，把名字为alex的人所在的地址国家改成Japan
db.user.update({'name':"alex"},{"$set":{"addr.country":"Japan"}})

#5、把名字为alex的人的地2个爱好改成piao
db.user.update({'name':"alex"},{"$set":{"hobbies.1":"piao"}})

#6、删除alex的爱好,$unset
db.user.update({'name':"alex"},{"$unset":{"hobbies":""}})



=========================================增加和减少$i:nc=====================================
#1、所有人年龄增加一岁
db.user.update({},
    {
        "$inc":{"age":1}
    },
    {
        "multi":true
    }
    )
#2、所有人年龄减少5岁
db.user.update({},
    {
        "$inc":{"age":-5}
    },
    {
        "multi":true
    }
    )
=========================================添加删除数组元素==================================
往数组内添加元素:$push
#1、为名字为yuanhao的人添加一个爱好read
db.user.update({"name":"yuanhao"},{"$push":{"hobbies":"read"}})

#2、为名字为yuanhao的人一次添加多个爱好tea，dancing
db.user.update({"name":"yuanhao"},{"$push":{
    "hobbies":{"$each":["tea","dancing"]}
}})

按照位置且只能从开头或结尾删除元素：$pop
#3、{"$pop":{"key":1}} 从数组末尾删除一个元素

db.user.update({"name":"yuanhao"},{"$pop":{
    "hobbies":1}
})

#4、{"$pop":{"key":-1}} 从头部删除
db.user.update({"name":"yuanhao"},{"$pop":{
    "hobbies":-1}
})

#5、按照条件删除元素,："$pull" 把符合条件的统统删掉，而$pop只能从两端删
db.user.update({'addr.country':"China"},{"$pull":{
    "hobbies":"read"}
},
{
    "multi":true
}
)


=====================================避免添加重复：$addToSet===========================
#自动去除重复
db.urls.insert({"_id":1,"urls":[]})
db.urls.update({"_id":1},{"$addToSet":{"urls":'http://www.baidu.com'}})
db.urls.update({"_id":1},{"$addToSet":{"urls":'http://www.baidu.com'}})
db.urls.update({"_id":1},{"$addToSet":{"urls":'http://www.baidu.com'}})

db.urls.update({"_id":1},{
    "$addToSet":{
        "urls":{
        "$each":[
            'http://www.baidu.com',
            'http://www.baidu.com',
            'http://www.xxxx.com'
            ]
            }
        }
    }
)


=====================================其他========================================
#1、了解：限制大小"$slice"，只留最后n个

db.user.update({"_id":5},{
    "$push":{"hobbies":{
        "$each":["read",'music','dancing'],
        "$slice":-2
    }
    }
})

#2、了解：排序The $sort element value must be either 1 or -1"
db.user.update({"_id":5},{
    "$push":{"hobbies":{
        "$each":["read",'music','dancing'],
        "$slice":-1,
        "$sort":-1
    }
    }
})

#注意：不能只将"$slice"或者"$sort"与"$push"配合使用，且必须使用"$eah"
```



## 删除数据

```python
# 删除多个中的第一个
db.user.deleteOne({"age":8})

# 删除符合条件的全部
db.user.deleteMany({"age"：18})

# 删除全部
db.user.deleteMany({})
```



