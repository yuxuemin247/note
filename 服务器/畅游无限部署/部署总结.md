####                                      客户端部署流程

#### 项目提交拉取

- 项目配置文件,要整体存放在`conf`包中
  - 关于数据库连接配置,缓存配置,debug,日志处理目录要统一收集在`env.py`文件中
  
  - 方便切换服务器,配置文件不可以上传到`gitee`上
  
  - 部署时,直接从`gitee`上拉取项目
  
  - 进行项目更新,要首先做备份,不在线上环境修改代码
  
  - 不同服务器配置文件,提前些好上传,不需要一直上传改动
  
  - 日志文件通过`syslog`收集到指定目录,不放在项目文件下
  
  - git拉取覆盖本地修改 
  
    ```
    git fetch --all
    git reset --hard origin/master
    ```
  
    

#### python环境安装

- `mysqlclient`安装问题
  - 出现`OSError:mysql_config not found`
    - 安装 apt-get install `libmysqlclient-dev python3-dev`

- `pymysql`安装问题
  - 出现版本检测和编码问题
    - 注释安装包中版本检测和编码即可
- request包
  - 出现`urlib3`和`chardet`依赖包版本不匹配问题
    - 卸载依赖包,重新安装request包

- 静态文件收集
  - 页面结构混乱,更新了代码后,静态文件已缓存未更新
  - `gitnore`过滤了dist文件夹,未上传静态文件

#### `Uwsgi`配置

- 项目文件统一放在`/srv`目录下,统一管理
  - `srv`文件夹提供此服务器提供的服务或数据
- 进程号文件`pid`保存在/var/run目录下
  -  /var/run 目录中存放系统进程启动的文件
  -  当机器关闭的时候，文件系统就清空了
- `uwsgi`启动的进程数目
  - 控制`uwsgi`启动的进程数,由supervisor守护多启`uwsgi`进程来实现  

- `uwsgi`用户和用户组

  - 使用`nodody`用户最低权限完全可以解决,避免项目漏洞导致服务器被攻击
  - 不要使用root用户
  - `nobody`用户时无法直接登录系统的.,保证不会通过漏洞连接到服务器做破坏,安全性较高

- `uwsgi`日志

  - 日志都不能存放在项目中,防止日志文件太大占用磁盘

  - 统一通过`syslog`收集到指定的目录下

#### `Nginx`配置

- 监听指定端口:6754,域名,指定项目目录
- 使用upstream负载到两个`uwsgi`实例上,设置超时时间

-  指定静态文件目录使用`Nginx`做静态文件的代理,效果较好
- 成功日志错误日志都通过`syslog`收集

- 重启使配置文件生效
  - 配置文件写完,要`nginx` -t检查语法错误
  - 重启使用 `nginx` -s reload  避免影响其他的服务挂掉

#### `supervisor`守护

- 通过program指定不同的服务名,command指定`cmd`命令,设置自动重启
- 日志文件打到`dev/null`,不要了

- 配置完成启动,配置文件在`/etc/supervisord.d`目录下
  - `supervisorctl` status
  - `supervisorctl` 服务名 要指定服务名
- 更新了配置文件,使用 `supervisorctl` update,避免使用reload影响其他服务