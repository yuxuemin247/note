[TOC]

# 中间件 ---  bbs

## 一、中间件

![django请求生命周期](.\img\django请求生命周期.jpg)

![中间件生命周期](.\img\中间件生命周期.png)

自定义中间件**

```python
# 自定义中间件类：app.testmiddleware.py
from django.utils.deprecation import MiddlewareMixin
class MyMiddleware1(MiddlewareMixin):
    def process_request(self, request):
        ''' 请求处理
        :param request:请求对象
        :return: 一般没有返回值，但可以返回HttpResponse对象
        '''
    def process_view(self, request, callback, callback_args, callback_kwargs):
        ''' 视图函数预处理
        :param request: 请求对象
        :param callback: 路由返回的视图函数地址
        :param callback_args: 视图函数的位置参数（元组）
        :param callback_kwargs: 视图函数的关键字参数（字典）
        :return: 一般没有返回值，但可以返回HttpResponse对象
        '''
    def process_exception(self, request, exception):
        ''' 视图函数异常处理
        :param request: 请求对象
        :param exception: 视图函数的异常对象
        :return: 一般没有返回值，但可以返回HttpResponse对象
        '''

    def process_template_response(self, request, response):
        ''' 视图函数返回值为拥有render方法的对象，该方法会执行
        :param request: 请求对象
        :param response: 响应对象
        :return: 一定要返回response
        '''
        return response
    def process_response(self, request, response):
        ''' 响应处理
        :param request: 请求对象
        :param response: 响应对象
        :return: 一定要返回response
        '''
        return response
    
class MyMiddleware2(MiddlewareMixin):
    def process_request(self, request):
        pass
```

### 使用自定义中间件

```python
# 在settings.py中配置自定义中间件
MIDDLEWARE = [
    ...
    'app.testmiddleware.MyMiddleware1',
    'app.testmiddleware.MyMiddleware2'
]
```

### form完成csrf认证

```html
<form action="" method="post">
    {% csrf_token %}
</form>
```

### ajax完成csrf认证

```html
<script src="/static/jquery-3.3.1.js"></script>
<script src="/static/jquery.cookie.js"></script>
<script>
    token = $.cookie('csrftoken');
    $.ajax({
        url: '/',
        type: 'post',
        headers:{'X-CSRFToken': token},
        data: {
            msg: '请求数据'
        },
        success: function (data) {
            console.log(data)
        }
    })
</script>
```

## 二、BBS项目

### 需求分析

```python
'''
1. 注册：前后台校验、ajax注册、选取图形、图形上传
2、登录：ajax登录、图形验证码
3、博客首页
4、个人站点
5、文章的点赞与点踩
6、评论：根评论、子评论
7、后台管理
8、发布博客：防xss攻击
'''
```

### 数据库分析

![bbs表关系](G:\资料\笔记\5.Django\img\bbs表关系.png)

```python
'''
用户表：User
	username：账号
	password：密码
	data_joined：注册时间
	email: 邮箱
	avatar：图像
	telephone：电话
	blog：博客站点(一对一)

博客站点表：Blog
	site: 站点域名
	name：站点名
	title：标题
	theme：站点主体样式
	category：拥有的分类(多对多)
	tag: 拥有的标签(多对多)
	
分类表：Category
	name：分类名
	
标签表：Tag
	name：标签名

文章表：Article
	title：文章标题
	desc：文章摘要
	content：文章内容
	create_time：发布事件
	blog：所属博客站点(一对多)
	category：所属分类(一对多)
	tag：拥有的标签(多对多)

点赞点踩表：UpOrDown  # user与article的点踩关系表
	user：点赞点踩用户(一对多)
	article：点赞点踩文章(一对多)
	is_up：点赞或点踩
	
评论表：Common  # user与article的评论关系表
	user：点赞点踩用户(一对多)
	article：点赞点踩文章(一对多)
	content：评论内容
	parent：父评论(自关联, 一对多)
'''
```

### 接口规则

```python
'''
演示：
http://api.map.baidu.com/place/v2/search?ak=6E823f587c95f0148c19993539b99295&output=json&query=%E8%82%AF%E5%BE%B7%E5%9F%BA&region=%E5%8C%97%E4%BA%AC

状态码：
SUCCESS("0000", "查询成功"),
NODATA("0001", "查询成功无记录"),
FEAILED("0002", "查询失败"),
ACCOUNT_ERROR("1000", "账户不存在或被禁用"),
API_NOT_EXISTS("1001", "请求的接口不存在"),
API_NOT_PER("1002", "没有该接口的访问权限"),
PARAMS_ERROR("1004", "参数为空或格式错误"),
SIGN_ERROR("1005", "数据签名错误")
UNKNOWN_IP("1099", "非法IP请求"),
SYSTEM_ERROR("9999", "系统异常");

规范制定：
{
    'statue': 0,
    'msg': 'ok',
    'data': {}
}
'''
```

### 相关配置

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'bbs',
        'HOST': '127.0.0.1',
        'USER': 'root',
        'PASSWORD': '123456'
    }
}
AUTH_USER_MODEL = 'blog.User'

STATICFILES_DIRS = [
    os.path.join(BASE_DIR, 'static')
]

import pymysql
pymysql.install_as_MySQLdb()
```

