[TOC]

# 个人站点布局 --- 后台管理布局 --- 文本编辑设置

## 个人站点整体布局

```python
'''
网址后输入站点名即可访问站点： /xxx
'''
'''
url:
# 个人站点
url(r'^(?P<site>\w+)/(?P<group>category|tag|archive)/(?P<key>.+)$',views.site),

url(r'^(?P<site>\w+)$',views.site),
url(r'^(?P<site>\w+)/$',views.site),
'''
'''
views:
# 个人站点
def site(request,site,group=None,key=None):
    # url匹配的当前站点
    blog = Blog.objects.filter(site=site).first()
    if not blog:
        return HttpResponse('404')

    # 该站点下的分组与该分组下的文章数
    # [(key,values),...]
    category_set = blog.category.all() \
        .filter(articledetail__article__blog=blog) \
        .values('name').annotate(c=Count('articledetail')) \
        .values_list('name', 'c')

    print(category_set)

    # 标签
    # [{'name':'个人'，'c':6},...]
    tag_list = blog.tag.all() \
        .filter(articledetail__article__blog=blog) \
        .values('name').annotate(c=Count('articledetail'))
    print(tag_list)

    # 档案
    # [{'month': datetime.date(2018, 3, 1), 'c': 1},...]
    time_list = blog.article_set.all()\
        .annotate(month=TruncMonth('create_time'))\
        .values('month').annotate(c=Count('pk')).order_by('-month')
    print(time_list)

    # 点击具体的分组|标签|档案,只是数据源发生了变化,所以不需要更改页面
    article_list = Article.objects.filter(blog=blog).all()
    # 筛选数据
    if group and key:
        if group == 'category':
            article_list = article_list.filter(article_detail__category__name=key)
        elif group == 'tag':
            article_list = article_list.filter(article_detail__tag__name=key)
        else:
            times = key.split('-')
            article_list = 	                       article_list.filter(create_time__year=times[0],create_time__month=times[1])				

    return render(request, 'site.html', locals())
'''
'''
admin:
admin.site.register(ArticleDetail)
'''
```

```html
//样式
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>个人站点</title>
    <link rel="stylesheet" href="/static/bs-3.3.7/css/bootstrap.css">
    <link rel="stylesheet" href="/static/css/{{ blog.theme }}">
</head>
<body>
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">博客菜园</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li><a id="site" href="#">{{ blog.title }}<span class="sr-only">(current)</span></a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                {% if request.user.is_authenticated %}
                    <li><a href="#">{{ request.user.username }}</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                           aria-expanded="false">个人中心<span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="/backend/">后台管理</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="/my_logout/">注销</a></li>
                        </ul>
                    </li>
                {% else %}
                    <li><a href="/my_login/">登录</a></li>
                    <li><a href="/register/">注册</a></li>
                {% endif %}
            </ul>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>

<div class="container-fluid">
    <div class="row">
        {# 展示菜单#}
        <div class="col-md-3">
            <div class="panel panel-primary">
                <div class="panel-heading">文章分类</div>
                <div class="panel-body">
                    {% for category_tuple in category_set %}
                        <p>
                            <a href="/{{ blog.site }}/category/{{ category_tuple.0 }}">{{ category_tuple.0 }} ({{ category_tuple.1 }})</a>
                        </p>
                    {% endfor %}
                </div>
            </div>
            <div class="panel panel-info">
                <div class="panel-heading">文章标签</div>
                <div class="panel-body">
                    {% for tag in tag_list %}
                        <p>
                            <a href="/{{ blog.site }}/tag/{{ tag.name }}">{{ tag.name }} ({{ tag.c }})</a>
                        </p>
                    {% endfor %}
                </div>
            </div>
            <div class="panel panel-danger">
                <div class="panel-heading">文章档案</div>
                {% for time in time_list %}
                    <p>
                        <a href="/{{ blog.site }}/archive/{{ time.month|date:'Y-m' }}">
                            {{ time.month|date:'Y年m月' }}
                            ({{ time.c }})
                        </a>
                    </p>
                {% endfor %}
            </div>
        </div>
        {# 展示文章#}
        <div class="col-md-9">
            {% for article in article_list %}
                <div class="media clearfix" style="margin-bottom: 30px">
                    <div class="media-left media-middle">
                        <a href="#">
                            <img class="media-object" src="/media/{{ article.blog.user.avatar }}" alt="">
                        </a>
                    </div>
                    <div class="media-body">
                        {{ article.desc }}
                    </div>
                    <div class="pull-right">
                        <span><b>{{ article.blog.user.username }}</b></span>
                        <span>{{ article.create_time }}</span>
                        <span>评论（0）</span>
                        <span>点赞（{{ article.up_count }}）</span>
                        <span>点踩（{{ article.down_count }}）</span>
                    </div>
                    <hr>
                </div>
            {% endfor %}
        </div>

    </div>
</div>
</body>
<script src="/static/bs-3.3.7/js/jquery-3.3.1.js"></script>
<script src="/static/bs-3.3.7/js/bootstrap.js"></script>
</html>
```

### 注册用户设置默认主题

css

```css
#site {
    font-size: 30px;
    color: red;
}
```

views:

```python
 # 为该用户创建一个默认样式文件
                path = 'static/css/%s.css' % u_name
                with open(path, 'wt') as f:
                    f.write("#site {font-size: 30px;color: orange;}")
```

## 后台管理布局

样式

backend_base.html :

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>后台管理</title>
    <link rel="stylesheet" href="/static/bs-3.3.7/css/bootstrap.css">
</head>
<body>
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">博客菜园</a>
        </div>
        <ul class="nav navbar-nav navbar-right">
            {% if request.user.is_authenticated %}
                <li><a href="/{{ request.user.blog.site }}/">{{ request.user.username }}</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                       aria-expanded="false">个人中心<span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="/backend/">后台管理</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="/my_logout/">注销</a></li>
                    </ul>
                </li>
            {% else %}
                <li><a href="/my_login/">登录</a></li>
                <li><a href="/register/">注册</a></li>
            {% endif %}
        </ul>
    </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2">
            <div class="panel panel-primary">
                <div class="panel-heading" role="tab" id="headingOne">
                    <h4 class="panel-title">
                        <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne"
                           aria-expanded="true" aria-controls="collapseOne">
                            博客设置
                        </a>
                    </h4>
                </div>
                <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
                    <ul class="list-group">
                        <li class="list-group-item">
                            <a href="/add_article/">添加文章</a>
                        </li>
                        <li class="list-group-item">
                            <a href="">设置主题</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="panel panel-danger">
                <div class="panel-heading" role="tab" id="headingTwo">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion"
                           href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            个人设置
                        </a>
                    </h4>
                </div>
                <div id="collapseTwo" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingTwo">
                    <ul class="list-group">
                        <li class="list-group-item">
                            <a href="">设置密码</a>
                        </li>
                        <li class="list-group-item">
                            <a href="">设置图像</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-md-10">
            {% block content %}

            {% endblock %}
        </div>
    </div>
</div>

</body>
<script src="/static/bs-3.3.7/js/jquery-3.3.1.js"></script>
<script src="/static/bs-3.3.7/js/bootstrap.js"></script>

{% block script %}

{% endblock %}
</html>
```

backend.html

```html
{% extends 'backends/backend_base.html' %}

{% block content %}
    <div>
        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active">
                <a href="#home" aria-controls="home" role="tab" data-toggle="tab">公开</a>
            </li>
            <li role="presentation">
                <a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">私密</a>
            </li>
        </ul>

        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="home">

                <table class="table">
                    <thead>
                    <tr>
                        <th>标题</th>
                        <th>评论</th>
                        <th>点赞</th>
                        <th>点踩</th>
                        <th>编辑</th>
                        <th>删除</th>
                    </tr>
                    </thead>
                    <tbody>
                        {% for article in article_list %}
                            <tr>
                            <td>
                                <a href="">{{ article.title }}</a>
                            </td>
                            <td>0</td>
                            <td>{{ article.up_count }}</td>
                            <td>{{ article.down_count }}</td>
                            <td>
                                <a href="">编辑</a>
                            </td>
                            <td>
                                <a href="">删除</a>
                            </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>

            </div>
            <div role="tabpanel" class="tab-pane" id="profile">56789</div>
        </div>
    </div>

{% endblock %}
```

views:

```python
# 后台管理
@login_required(login_url='/my_login/')
def backend(request):
    article_list = Article.objects.all().filter(blog=request.user.blog)
    return render(request, 'backends/backend.html', locals())
```

### 后台登录认证转跳

```python
def my_login(request):
    if request.method == "GET":
        next_url = request.GET.get('next', 0)
        return render(request, 'login.html', locals())

    if request.method == "POST":
        client_code = request.POST.get('img_code', None).lower()
        server_code = request.session.get('img_code', None).lower()
        next_url = request.GET.get('next', '/')
        username = request.POST.get('username', None)
        password = request.POST.get('password', None)
        user = authenticate(username=username, password=password)
        if user:
            login(request, user)
            return JsonResponse({
                'status': 0,
                'msg': "登录成功",
                'data': {
                    'backurl': next_url
                }
            })

```

login.html

```html
 $(".login").click(function () {
        token = $('[name=csrfmiddlewaretoken]').val();
        next_url = {{ next_url }};
        next = next_url ? '?next=' + next_url : '';
        $.ajax({
            url: '/my_login/' + next,
            type: 'post',
            data: {
                {#csrfmiddlewaretoken: '{{ csrf_token }}',#}
                csrfmiddlewaretoken: token,
                username: $('#username').val(),
                password: $('#password').val(),
                img_code: $('#img_code').val(),
            },
            success: function (data) {
                console.log(data);
                if (data.status == 0) {
                    location.href = data.data.backurl
                }
```

## 文章页面布局

布局

```html
{% extends 'backends/backend_base.html' %}


{% block content %}
    <h3 class="text-center">添加文章</h3>
    <form action="" method="post" style="border: 2px solid #337ab7; padding: 20px">
        {% csrf_token %}

        <div class="form-group">
            <label for="title" class="control-label">标题</label>
            <div>
                <input id="title" name="title" type="text" class="form-control">
            </div>
        </div>

        <div class="form-group">
            <label for="content" class="control-label">正文(kindeditor)</label>
            <div>
                <textarea id="content" name="content" cols="30" rows="10"></textarea>
            </div>
        </div>

        <div class="form-group">
            <label for="category_id" class="control-label">分组</label>
            <div>
                <select name="category_id" id="category_id" class="form-control">
                    {% for category in category_list %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}

                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="tag_ids" class="control-label">标签</label>
            <div>
                <select name="tag_ids" id="tag_ids" class="form-control" multiple>
                    {% for tag in tag_list %}
                        <option value="{{ tag.id }}">{{ tag.name }}</option>
                    {% endfor %}

                </select>
            </div>
        </div>

        <div class="form-group">
            <input type="submit" class="btn btn-primary" value="提交">
        </div>

    </form>

{% endblock %}


{% block script %}
    <script src="/static/kindeditor/kindeditor-all.js"></script>
    <script>
        KindEditor.ready(function (K) {
            window.editor = K.create('#content', {
                width: '100%',
                height: '400px',
                resizeType: 0,
                uploadJson: '/add_image/',
                extraFileUploadParams: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                }
            });
        });
    </script>
{% endblock %}


```

### 文本编辑器（kindeditor）

```python
'''
下载 kindeditor 放入 static
导入bs4
'''
```

```html
{% block script %}
    <script src="/static/kindeditor/kindeditor-all.js"></script>
    <script>
        KindEditor.ready(function (K) {
            window.editor = K.create('#content', {
                width: '100%',
                height: '400px',
                resizeType: 0,
                uploadJson: '/add_image/',
                extraFileUploadParams: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                }
            });
        });
    </script>
{% endblock %}
```

### 富文本上传图片

```python
# 添加文章正文图片
def add_image(request):
    print(request.FILES)

    path = 'media/img'
    if not os.path.exists(path):
        os.mkdir(path)

    file = request.FILES.get('imgFile', None)

    img_path = path + "/" + file.name
    with open(img_path, 'wb') as f:
       for line in file:
           f.write(line)

    return JsonResponse({
        "error": 0,
        'url': '/' + img_path
    })
```

```html
uploadJson: '/add_image/',
                extraFileUploadParams: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                }
```

### 添加文章

```python
# 后台的添加文章
@login_required(login_url='/my_login/')
def add_article(request):
    blog = request.user.blog
    if request.method == "GET":
        category_list = blog.category.all().order_by('pk')
        tag_list = blog.tag.all().order_by('pk')
        return render(request, 'backends/add_article.html', locals())
    if request.method == "POST":
        # print(request.POST)

        title = request.POST.get('title', None)
        content = request.POST.get('content', None)
        category_id = request.POST.get('category_id', None)
        tag_ids = request.POST.getlist('tag_ids', None)

        # 利用bs4模块解析html文本
        soup = BeautifulSoup(content, 'html.parser')
        desc = soup.text.strip()[0:100]  # 解析后数据存放在soup.text

        article = Article.objects.create(
            title=title,
            desc=desc,
            blog=blog,
        )

        article_detail = ArticleDetail.objects.create(
            content=content,
            category_id=category_id,
        )
        # 多对多利用第三张表的add方法
        article_detail.tag.add(*tag_ids)
        # 建立一对一关系
        article.article_detail = article_detail
        article.save()

        return redirect('/add_article/')
```



