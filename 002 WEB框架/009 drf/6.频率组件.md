# 频率组件

## 频率简介

```python
为了控制用户对某个url请求的频率
```

## 自定义频率组件

```python
# 自己定义的频率控制类
----------------------------MyAuth.py--------------------------------------
from rest_framework.throttling import BaseThrottle
class MyThrottling(BaseThrottle):
    VISIT_RECORD = {}
    def __init__(self):
        self.history=None
    def allow_request(self, request, view):
		# 1.取出访问者ip
        ip = request.META.get('REMOTE_ADDR')
        import time
        ctime = time.time()
        # 2.判断当前ip不在访问字典里，添加进去，并且直接返回True，表示第一次访问
        if ip not in self.VISIT_RECORD:
            self.VISIT_RECORD[ip] = [ctime, ]
            return True
        #self.history当前访问者访问的时间列表
        self.history = self.VISIT_RECORD.get(ip)
        # 3.循环判断当前ip的列表，有值，并且当前时间减去列表的最后一个时间大于60s，把这种数据pop掉，这样列表中只有60s以内的访问时间
        #[1s,20s，30s]
        while self.history and ctime - self.history[-1] > 60:
            self.history.pop()
        # 4.判断，当列表小于3，说明一分钟以内访问不足三次，把当前时间插入到列表第一个位置，返回True，顺利通过
        # 5.当大于等于3，说明一分钟内访问超过三次，返回False验证失败
        if len(self.history) < 3:
            self.history.insert(0, ctime)
            return True
        else:
            return False
    def wait(self):
        import time
        ctime = time.time()
        return 60 - (ctime - self.history[-1])
```

## 局部使用

在settings中配置：

```python
# 10/m m表示分钟，10表示次数。1分钟之内只能访问10次
REST_FRAMEWORK = {
    'DEFAULT_THROTTLE_RATES': {
        'luffy': '10/m'
    }
}
```

在视图类里使用

```python
throttle_classes = [MyThrottles,]

# 全局使用的局部禁用
throttle_classes=[]
```

```python

# ----------------------------------------------------------------------------
# drf给我们提供的频率控制类
from rest_framework.throttling import SimpleRateThrottle
class MyThrottling(SimpleRateThrottle):
    scope='luffy'
    def get_cache_key(self, request, view):
        # 必须重写get_cache_key 返回什么，频率组件会以什么做限制(比如返回ip，它就以ip做限制。如果返回user_id，它会以用户id做限制)
        self.get_ident(request)
        return request.META.get('REMOTE_ADDR')
    
----------------------------------views.py------------------------------------
from rest_framework.views import APIView
from rest_framework.response import Response
from app01.MyAuth import MyThrottling
class BooksView(APIView):
	# 局部认证
    throttle_classes=[MyThrottling]
    # 全局使用的局部禁用
    throttle_classes=[]
    def get(self,request):
        #request.user就是当前登录用户
        print(request.user)
        print(request.auth)
        return Response('ok')
```

## 全局使用

```python
# 在setting中配置
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': ['app01.MyAuth.MyThrottling', ]
}
```

# 