# request模块的使用

## get请求

### 请求参数

1.参数拼接时中文需要URLEncode，可以使用urllib中的编码函数来完成

```python
from urllib.parse import urlencode
import requests

params = {"wd":"美女"}
# 必须以字典类型传入需要编码的数据 得到拼接收的参数字符串
res = urlencode(params,encoding="utf-8")

url = "https://www.baidu.com/s"
url = url+"?"+res # 拼接参数

response = requests.get(url)

with open("test.html","wb") as f:
    f.write(response.content)
```

2.也可以直接将请求参数传给get的函数的params参数，get方法会自动完成编码

```python
import requests
# 参数字典
params = {"wd":"美女"}

url = "https://www.baidu.com/s"
# 直接传给params参数
response = requests.get(url,params=params)

with open("test.html","wb") as f:
    f.write(response.content)
```

上述的代码无法请求完成的数据 因为百度服务器有限制，必须制定用户代理，user-agent为浏览器才行

### 添加请求头

```python
#百度搜索
import requests
key = input('请输入关键字：')

# 手动进行中文编码
# from urllib.parse import urlencode
# print(urlencode({"wd:key"},encoding="utf-8"))

url = "https://www.baidu.com/s"
user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36"
resp = requests.get(url,
                    params={'wd':key},
                    headers = {"User-Agent":user_agent})
with open('baidu.html','wb') as f:
    f.write(resp.content)
```

### 带有cookies的请求

可以在headers中直接添加键值对也可以单独使用get方法的cookies参数

```python
import requests

url = "https://github.com/"

user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36"

cookie = "has_recent_activity=1; _ga=GA1.2.2022750455.1554880344; _gat=1; _octo=GH1.1.1046972625.1554880344; tz=Asia%2FShanghai; _device_id=1741760db0afe98d7421095e093591fa; user_session=_dKVhga81lwDQz8GcEHih1EHDSnVlHIgJA6PKu_xIyxGgnxN; __Host-user_session_same_site=_dKVhga81lwDQz8GcEHih1EHDSnVlHIgJA6PKu_xIyxGgnxN; logged_in=yes; dotcom_user=oldboyedujerry; _gh_sess=U0NJZy85U1BaVmtSd3piY3BGZ0M3V0RJenRjcEZCZHI5TGtuNWZqZjNud1pBOVR0K1lUZk9XRTNUY2ViSGtIQ0pVbDV4Y0ZEdk9GeGhYZ3BtVXlYYmtIYWc3ckJtMFZYdkpMK1JYZ1ZrWm5GNlM2VzdrWVlZNndlaUM3V0NEU1pETjEydzlMRWtEODRUY2dJbFNKMW1mMjM0bnZmL0Z1SVV0TldpUXBZSmppTGR6Tm9KaUpDTndaNnVZWmFDRmxlS3d3TlJTZGpOSVpzaHZhZW03R3Z5eVVWQWJVaFUvNlBka3B5OFZpdmJldWl6dDJCbjEwMVorM0dGK3pOUXMzRHZQU2NQQVJlUzFmT012ZmhKWFEycTExZDZSQ1VnREhNbHEvR2xudUNNbW1PT0o1MXkwSnI0OC84anRUNjhqYWlOK1hLdUFnQlVpWTg4MFFTeldBRkVpK2dQMTF1Q1hmNnJtVDlyQjB3T3VZPS0tTkxCSmx1QUdMVWg3M1BEbmhZMXN0UT09--782e5f85764c258336a9fe66faea11ddbf687a8b"
resp = requests.get(url,
             headers = {"user-agent":user_agent,
                        "Cookie":cookie,}
                   		# cookies={"has_recent_activity":"1"} # 已keyvalue的形式添加cookie
                   )

print(resp.status_code)
print("oldboyedujerry/testProject" in resp.text)

# 使用cookies参数  注意需要拆分为单独的键值对
#response = requests.get(url,headers=headers,cookies={"_octo":"GH1.1.1155792533.1532919557"})
```

requests模块自动处理cookies

## post请求

post请求不同之处仅在于参数提交通过post方法的data参数来指定:

模拟登录流程并爬取github私有页面

```python
# 登录github
import requests
import re


user_agent = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36"
# 创建一个会话
session = requests.session()


# 1.请求登录页面
res = session.get("https://github.com/login",headers={
    "Referer": "https://github.com/",
    "User-Agent": user_agent
})
print(res.status_code)
token = re.search('name="authenticity_token" value="(.*?)"',res.text).group(1)
print(token)

# 2.发送登录请求,带上cookie,带上请求体,带上token
res2 = session.post("https://github.com/session",
                     headers = {
                         "Referer": "https://github.com/login",
                         "User-Agent": user_agent},
                     data={
                         "commit": "Sign in",
                         "utf8": "✓",
                         "authenticity_token": token,
                         "login": "oldboyedujerry",
                         "password": "123654asdAsd"},
                     allow_redirects = True)
print(res2.status_code)
# 访问个人主页
res3 = session.get("https://github.com/settings/profile",
                    headers={
                        "User-Agent": user_agent,
                        "Referer": "https://github.com/login"
                    })

print(res3.status_code)
with open("tt.html","wt") as f:
    f.write(res3.text)
# 判断是否登录成功
print("oldboyedujerry" in  res3.text)


```

注意通常登录时都会带token,需要先获取token才能进行post登录

### session的使用

使用会话来完成请求，会话会自动帮我们保存和提交cookie

```python
user_agent = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36"
# 创建一个会话
session = requests.session()


# 1.请求登录页面
res = session.get("https://github.com/login",headers={
    "Referer": "https://github.com/",
    "User-Agent": user_agent
})
print(res.status_code)
token = re.search('name="authenticity_token" value="(.*?)"',res.text).group(1)
print(token)

# 2.发送登录请求,带上cookie,带上请求体
res2 = session.post("https://github.com/session",
                     headers = {
                         "Referer": "https://github.com/login",
                         "User-Agent": user_agent},
                     data={
                         "commit": "Sign in",
                         "utf8": "✓",
                         "authenticity_token": token,
                         "login": "oldboyedujerry",
                         "password": "123654asdAsd"},
                     allow_redirects = False
                     )

print(res2.status_code)

# 访问个人主页
res3 = session.get("https://github.com/settings/profile",
                    headers={
                        "User-Agent": user_agent,
                        "Referer": "https://github.com/login"
                    })

print(res3.status_code)

with open("tt.html","wt") as f:
    f.write(res3.text)
# 判断是否登录成功
print("oldboyedujerry" in  res3.text)
```

## response属性

```python
import requests
url = "https://www.baidu.com/s"

resp = requests.get(url,params={"wd":"egon"},headers={"user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3538.77 Safari/537.36"})

# print(resp.text)
# print(resp.content)
# print(resp.status_code)
# print(resp.url) # 当前地址
# print(resp.cookies) #获取返回的cookies信息
# print(resp.cookies.get_dict()) #获取返回的cookies信息
# print(resp.json()) # 将结果进行反序列化
# print(resp.request) #请求方式
# print(resp.apparent_encoding) # 从文档中获取编码
# print(resp.encoding)
# print(resp.headers) # 查看响应头
print(resp.history) # 重定向历史


resp = requests.get(url,
                    params={"wd":"egon"},
                    headers={"user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3538.77 Safari/537.36"},
                    stream=True)
# 以流的方式读取原始数据，没有经过HTTP协议解析的数据，一般不常用
print(resp.raw.read(100))

# 当文档的编码方式response解码方式不同时，需要手动指定
resp2 = requests.get("http://www.autohome.com/news")
# 以文档声明的方式来解码
resp2.encoding = resp2.apparent_encoding
print(resp2.text)
```

## 请求参数详解

```python
import requests
# 给服务器传参数
requests.get('url',params={'key':'value'})

# post请求 data和json都能传参数
requests.post("url",data={"name":"jerry","pwd":"123"},json={"name":"jerry","pwd":"123"})
# data 拼接为：name=jerry&pwd=123
# json 直接序列化成字符串 {"name":"jerry","pwd":"123"}

# 超时时间 第一个表示连接超时时间，2表示响4应超时时间
requests.post("https://www.baidu.com",timeout=(2,2))

# 代理池，对于爬虫是相当重要的参数
ps = ["121.228.240.101:9999","121.228.240.101:9999","121.228.240.101:9999","121.228.240.101:9999"]
import random
# 使用代理服务器请求
resp = requests.post("http://news.baidu.com/?tn=news",proxies={"HTTP":random.choice(ps)})
with open('new_baidu.html','wb') as f:
    f.write(resp.content)

# 上传文件
f = open(r"D:\aa.png","rb")

# 接收一个字典，key是服务器用于提取文件的字段名，f是要上传的文件对象
resp = requests.post("http://httpbin.org/post",files={"img":f})
print(resp.status_code)
```

